--------------------------------------------------------------------------------
-- File: basic_probe_driver_custom_inst_shim.vhd
-- Generated: 2025-11-05 06:57:05
-- Generator: tools/generate_custom_inst_v2.py
-- Template Version: 2.0 (BasicAppDataTypes)
--
-- ⚠️  GENERATED FILE - DO NOT EDIT MANUALLY ⚠️
-- This file is automatically generated from basic_probe_driver.yaml.
-- To modify, update the YAML file and regenerate.
--
-- Description:
--   Register mapping shim for basic_probe_driver with BasicAppDataTypes.
--   Maps raw Control Registers (CR6-CR15) to typed application signals
--   using automatic register packing from BADRegisterMapper.
--
-- Platform: Moku:Go
-- Clock Frequency: 125 MHz
--
-- Register Mapping (best_fit strategy):
--   CR6: monitor_window_duration [31:0]--   CR7: monitor_window_start [31:0]--   CR8: cooldown_interval [31:8]--   CR9: intensity_duration [31:16] | intensity_voltage [15:0]--   CR10: monitor_threshold_voltage [31:16] | probe_monitor_feedback [15:0]--   CR11: trig_out_duration [31:16] | trig_out_voltage [15:0]--   CR12: trigger_wait_timeout [31:16] | auto_rearm_enable [15] | fault_clear [14] | monitor_enable [13] | monitor_expect_negative [12]--   Total: 7 registers, 204/224 bits (91.1% efficiency)
--
-- Architecture:
--   Layer 1: MCC_TOP_custom_inst_loader.vhd (static, shared)
--   Layer 2: basic_probe_driver_custom_inst_shim.vhd (THIS FILE - generated)
--   Layer 3: basic_probe_driver_custom_inst_main.vhd (application logic)
--
-- References:
--   - basic_probe_driver.yaml
--   - docs/BasicAppDataTypes/
--------------------------------------------------------------------------------

library IEEE;
use IEEE.std_logic_1164.all;
use IEEE.numeric_std.all;

library WORK;
use WORK.custom_inst_common_pkg.all;
use WORK.basic_app_types_pkg.all;
use WORK.basic_app_voltage_pkg.all;
use WORK.basic_app_time_pkg.all;
entity basic_probe_driver_custom_inst_shim is
    generic (
        CLK_FREQ_HZ : integer := 125000000  -- Moku:Go clock frequency
    );
    port (
        ------------------------------------------------------------------------
        -- Clock and Reset
        ------------------------------------------------------------------------
        Clk         : in  std_logic;
        Reset       : in  std_logic;  -- Active-high reset

        ------------------------------------------------------------------------
        -- VOLO Control Signals (from MCC_TOP_custom_inst_loader)
        ------------------------------------------------------------------------
        volo_ready  : in  std_logic;  -- CR0[31] - Set by loader
        user_enable : in  std_logic;  -- CR0[30] - User control
        clk_enable  : in  std_logic;  -- CR0[29] - Clock gating
        loader_done : in  std_logic;  -- BRAM loader FSM done signal

        ------------------------------------------------------------------------
        -- Handshaking Protocol
        ------------------------------------------------------------------------
        ready_for_updates : in  std_logic;  -- From main application

        ------------------------------------------------------------------------
        -- Application Registers (from MCC_TOP_custom_inst_loader)
        -- Control Registers CR6-CR15
        ------------------------------------------------------------------------
        app_reg_6 : in  std_logic_vector(31 downto 0);        app_reg_7 : in  std_logic_vector(31 downto 0);        app_reg_8 : in  std_logic_vector(31 downto 0);        app_reg_9 : in  std_logic_vector(31 downto 0);        app_reg_10 : in  std_logic_vector(31 downto 0);        app_reg_11 : in  std_logic_vector(31 downto 0);        app_reg_12 : in  std_logic_vector(31 downto 0)    );
end entity basic_probe_driver_custom_inst_shim;

architecture rtl of basic_probe_driver_custom_inst_shim is

    ----------------------------------------------------------------------------
    -- Typed Signal Declarations (BasicAppDataTypes)
    ----------------------------------------------------------------------------
    signal trigger_wait_timeout : unsigned(15 downto 0);  -- Maximum time to wait in ARMED before timing out.
    signal auto_rearm_enable : std_logic;  -- When true, FSM re-enters ARMED after cooldown instead of idling.
    signal fault_clear : std_logic;  -- Write 1 to clear fault state and re-arm eligibility.
    signal trig_out_voltage : signed(15 downto 0);  -- Output voltage level for the digital trigger line (mV).
    signal trig_out_duration : unsigned(15 downto 0);  -- Duration of the trigger_out pulse.
    signal intensity_voltage : signed(15 downto 0);  -- Analog intensity/power control voltage delivered to the probe (mV).
    signal intensity_duration : unsigned(15 downto 0);  -- Duration of the intensity drive window.
    signal cooldown_interval : unsigned(23 downto 0);  -- Cooldown dwell enforced between pulses.
    signal probe_monitor_feedback : signed(15 downto 0);  -- Signed probe current monitor (mV); negative indicates rising current draw.
    signal monitor_enable : std_logic;  -- Enable probe monitor threshold evaluation.
    signal monitor_threshold_voltage : signed(15 downto 0);  -- Threshold (mV) the monitor must cross within the observation window.
    signal monitor_expect_negative : std_logic;  -- True when a negative-going crossing counts as “probe fired”.
    signal monitor_window_start : unsigned(31 downto 0);  -- Delay after trigger before monitoring window opens.
    signal monitor_window_duration : unsigned(31 downto 0);  -- Length of monitoring window starting at monitor_window_start.

    ----------------------------------------------------------------------------
    -- Global Enable Signal
    ----------------------------------------------------------------------------
    signal global_enable : std_logic;

begin

    ----------------------------------------------------------------------------
    -- Global Enable Computation
    ----------------------------------------------------------------------------
    global_enable <= combine_volo_ready(volo_ready, user_enable, clk_enable, loader_done);

    ----------------------------------------------------------------------------
    -- Atomic Register Update Process
    --
    -- Extracts typed values from packed registers on rising_edge when
    -- ready_for_updates='1'. Type conversions use frozen VHDL packages.
    ----------------------------------------------------------------------------
    REGISTER_UPDATE_PROC: process(Clk)
    begin
        if rising_edge(Clk) then
            if Reset = '1' then
                -- Load default values from YAML specification
                trigger_wait_timeout <= to_unsigned(2, 16);  -- Maximum time to wait in ARMED before timing out.
                auto_rearm_enable <= '0';  -- When true, FSM re-enters ARMED after cooldown instead of idling.
                fault_clear <= '0';  -- Write 1 to clear fault state and re-arm eligibility.
                trig_out_voltage <= to_signed(0, 16);  -- Output voltage level for the digital trigger line (mV).
                trig_out_duration <= to_unsigned(100, 16);  -- Duration of the trigger_out pulse.
                intensity_voltage <= to_signed(0, 16);  -- Analog intensity/power control voltage delivered to the probe (mV).
                intensity_duration <= to_unsigned(200, 16);  -- Duration of the intensity drive window.
                cooldown_interval <= to_unsigned(10, 24);  -- Cooldown dwell enforced between pulses.
                probe_monitor_feedback <= to_signed(0, 16);  -- Signed probe current monitor (mV); negative indicates rising current draw.
                monitor_enable <= '1';  -- Enable probe monitor threshold evaluation.
                monitor_threshold_voltage <= to_signed(-200, 16);  -- Threshold (mV) the monitor must cross within the observation window.
                monitor_expect_negative <= '1';  -- True when a negative-going crossing counts as “probe fired”.
                monitor_window_start <= to_unsigned(0, 32);  -- Delay after trigger before monitoring window opens.
                monitor_window_duration <= to_unsigned(5000, 32);  -- Length of monitoring window starting at monitor_window_start.
            elsif ready_for_updates = '1' then
                -- Atomic update: Extract all typed values from packed registers
                trigger_wait_timeout <= unsigned(app_reg_12((31 downto 16)));  -- Maximum time to wait in ARMED before timing out. (raw time value)
                auto_rearm_enable <= app_reg_12(15);  -- When true, FSM re-enters ARMED after cooldown instead of idling.
                fault_clear <= app_reg_12(14);  -- Write 1 to clear fault state and re-arm eligibility.
                trig_out_voltage <= voltage_output_05v_s16_from_raw(app_reg_11((15 downto 0)));  -- Output voltage level for the digital trigger line (mV).
                trig_out_duration <= unsigned(app_reg_11((31 downto 16)));  -- Duration of the trigger_out pulse. (raw time value)
                intensity_voltage <= voltage_output_05v_s16_from_raw(app_reg_9((15 downto 0)));  -- Analog intensity/power control voltage delivered to the probe (mV).
                intensity_duration <= unsigned(app_reg_9((31 downto 16)));  -- Duration of the intensity drive window. (raw time value)
                cooldown_interval <= unsigned(app_reg_8((31 downto 8)));  -- Cooldown dwell enforced between pulses. (raw time value)
                probe_monitor_feedback <= voltage_input_20v_s16_from_raw(app_reg_10((15 downto 0)));  -- Signed probe current monitor (mV); negative indicates rising current draw.
                monitor_enable <= app_reg_12(13);  -- Enable probe monitor threshold evaluation.
                monitor_threshold_voltage <= voltage_input_20v_s16_from_raw(app_reg_10((31 downto 16)));  -- Threshold (mV) the monitor must cross within the observation window.
                monitor_expect_negative <= app_reg_12(12);  -- True when a negative-going crossing counts as “probe fired”.
                monitor_window_start <= unsigned(app_reg_7((31 downto 0)));  -- Delay after trigger before monitoring window opens. (raw time value)
                monitor_window_duration <= unsigned(app_reg_6((31 downto 0)));  -- Length of monitoring window starting at monitor_window_start. (raw time value)
            end if;
        end if;
    end process REGISTER_UPDATE_PROC;

    ----------------------------------------------------------------------------
    -- Main Application Instantiation
    ----------------------------------------------------------------------------
    MAIN_INST: entity WORK.basic_probe_driver_custom_inst_main
        generic map (
            CLK_FREQ_HZ => CLK_FREQ_HZ
        )
        port map (
            Clk                => Clk,
            Reset              => Reset,
            global_enable      => global_enable,
            ready_for_updates  => open,  -- Driven by main, connected here

            -- Application signals (typed)
            trigger_wait_timeout => trigger_wait_timeout,            auto_rearm_enable => auto_rearm_enable,            fault_clear => fault_clear,            trig_out_voltage => trig_out_voltage,            trig_out_duration => trig_out_duration,            intensity_voltage => intensity_voltage,            intensity_duration => intensity_duration,            cooldown_interval => cooldown_interval,            probe_monitor_feedback => probe_monitor_feedback,            monitor_enable => monitor_enable,            monitor_threshold_voltage => monitor_threshold_voltage,            monitor_expect_negative => monitor_expect_negative,            monitor_window_start => monitor_window_start,            monitor_window_duration => monitor_window_duration        );

end architecture rtl;